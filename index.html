<!doctype html><html>
    <head>
        <title>TechPro Connect</title>
        <meta charset="UTF-8">
        <meta name="theme-color" content="#25ff88">
        <link rel="icon" href="Images/logo_new.svg">
        <link rel="icon" href="Images/logo_new.png">
        <link rel="stylesheet" href="Styles/main.css">
        <script src="Scripts/socket.io.js"></script>
    </head>
    <body onload="main()">
        <div id="chat">
        </div>
        <div id="input">
            <input id="textinput" type="text" placeholder="Type a message" />
            <button id="textsubmit">Send</button>
        </div>
        <iframe style="display: none;" width="0" height="0" src="https://prod-179.westus.logic.azure.com:443/workflows/dcbe4d5a55ad4a37850ced68c40fd4fd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=faqihrGIsw774hHAlWTrQqRkvlm-rXHWPQuXBzl4idQ"></iframe>
        <script>
            // Prompt user for username
            function main(){
            var user = prompt("Please enter your username: ").trim();
                
            // Initialize variables
            var lastMessageUser = "";
            
            // Initialize socket.io server connection
            const socket = io("https://core.techproservices.repl.co",
            { transports: ['websocket', 'polling'] });
            socket.on("connect", function (){
                console.log("Socket Connected");
                socket.emit("join", {username: user, ua: navigator.userAgent});
            });
            socket.on("log", function (data){
                console.log("New user: " + data.ua);
            });
            
            // Handle messages that user sends
            function handleMessage(){
                let message = textinput.value;
                if(message != ""){
                    textinput.value = "";
                    socket.emit("message", message);
                    let HTMLmessage = document.createElement('div');
                    HTMLmessage.classList = "message from-me";
                    if(lastMessageUser != user){
                        HTMLmessage.innerHTML = `<div class="message-sender">${user}</div>${message}`;
                    }
                    else{
                        HTMLmessage.innerText = message;
                        HTMLmessage.classList += " messageBelow";
                    }
                    chat.insertAdjacentElement('beforeEnd',HTMLmessage).scrollIntoView();
                    lastMessageUser = user;
                }
                else{
                    alert("Please enter a message first.");
                }
            }
            
            // Handle messages that user receives
            socket.on('message', function(data){
                let {username, message} = data;
                console.log(`Received ${message} from ${username}`);
                let HTMLmessage = document.createElement('div');
                HTMLmessage.classList = "message from-other";
                if(lastMessageUser != username){
                    HTMLmessage.innerHTML = `<div class="message-sender">${username}</div>${message}`;
                }
                else{
                    HTMLmessage.innerHTML = message;
                    HTMLmessage.classList += " messageBelow";
                }
                chat.insertAdjacentElement('beforeEnd',HTMLmessage).scrollIntoView();
                lastMessageUser = username;
            });
            
            // Handle system messages
            socket.on('system-message', function(data){
                console.log(`System message: ${data}`);
                let HTMLmessage = document.createElement('div');
                HTMLmessage.classList = "system-message";
                HTMLmessage.innerText = data;
                chat.insertAdjacentElement('beforeEnd',HTMLmessage).scrollIntoView();
                lastMessageUser = 'system';
            });
            
            // Get DOM objects
            var chat = document.getElementById("chat");
            var textinput = document.getElementById("textinput");
            var textsubmit = document.getElementById("textsubmit");
            
            // Respond to user submitting message
            textsubmit.addEventListener('click', handleMessage);
            textinput.addEventListener('keydown', function(e){
                switch(e.key){
                    case "Enter":
                        handleMessage();
                        break;
                    default:
                        break;
                }
            });
            }
        </script>
    </body>
</html>